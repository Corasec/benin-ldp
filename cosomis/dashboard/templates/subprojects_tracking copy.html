{% load static i18n bootstrap4 custom_tags %}
{% if datas_summary_subprojects_by_sectors_1 %}

<div class="card">
    <div class="card-header">
        <h5 class="font-weight-bold">{% translate "Number of subprojects by prefecture and sector" %}</h5>
    </div>
    <div class="row">
        <div class="col-10">
            <div class="input-group mb-3 search-bar">
                <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                </div>
                <input class="form-control" id="search" placeholder="{% translate 'Search' %}...">
            </div>
        </div>
        <div class="col-2">
            <div class="text-right mb-4">
                <form method='post'action="{% url 'dashboard:dashboard_download_excel_file' %}">
                    <button class="btn btn-primary btn-xs" type="submit" id="export-subprojects-number">
                        <i class="fa fa-file-export"></i> {% translate 'Export file' %}
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="card-body table-responsive">
        <table id="table-subprojects-number" class="table table-striped table-secondary" >
            <thead>
            {% if queryset_results.administrative_level_type %}
            <tr>
                <td colspan="{{ datas_summary_subprojects_by_sectors_1.keys|length }}" scope="col">{{ queryset_results.administrative_level_type }}</td>
            </tr>
            {% endif %}
            <tr>
                {% for column in datas_summary_subprojects_by_sectors_1.keys %}
                <td 
                    {% if column != 'Sectors' and column != 'Secteurs' and column != 'Type' %}
                    
                    {% endif %}
                    >{{ column }}</td>
                {% endfor %}
            </tr>
            </thead>
            <tbody>
                {% for i in datas_summary_subprojects_by_sectors_1_length_loop %}
                <tr>
                    {% for column in datas_summary_subprojects_by_sectors_1.keys %}
                    <td 
                        {% if column == 'Sectors' or column == 'Secteurs' or column == 'Type' %}
                            align="left"
                        {% endif %}
                        >
                        {% with datas_summary_subprojects_by_sectors_1_values|get_on_list:forloop.counter0 as value %}
                            {% with value|get:i as v %}
                                {% if v %}{{ v }}{% else %} - {% endif %}
                            {% endwith %}
                        {% endwith %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="font-weight-bold d-flex justify-content-center text-danger" >
    <p>{% translate 'Empty!' %}</p>
</div>
{% endif %}

<a id="downloard_a"></a>


<!-- DataTables export files -->
<script src="{% static 'AdminLTE/plugins/datatables-buttons/js/dataTables.buttons.min.js' %}"></script>
<script src="{% static 'AdminLTE/plugins/datatables-buttons/js/buttons.html5.min.js' %}"></script>

<script type="text/javascript">

    $(document).ready(function () {
        {% get_current_language as lang %}
        let table_subprojects_number = $('#table-subprojects-number').DataTable({
            language: {
                url: '{% static 'AdminLTE/plugins/datatables/locale/lang.json' %}'.replace('lang', '{{ lang }}')
            },
            dom: "ltipr",
            buttons: [
                {
                    extend: 'excel',
                    exportOptions: {
                        columns: [0, 2, 3]
                    }
                }
            ],
            lengthMenu: [10, 50, 100, 200],
            pageLength: 10
        });
        $('#search').on('keyup', function () {
            table_subprojects_number.search($(this).val()).draw();
        });

        $("#export-subprojects-number").on("click", function (event) {
            event.preventDefault();
            var datas_summary_subprojects_by_sectors_1_json = {{ datas_summary_subprojects_by_sectors_1|safe }};
            $.ajax({
                    type: "POST",
                    url: $(this).parent().attr('action'),
                    headers:{
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    data: JSON.stringify({
                        datas: datas_summary_subprojects_by_sectors_1_json,
                        type_datas: 'summary_subprojects_by_sectors_1' + '_{{ queryset_results.administrative_level_type }}_'
                    }),
                    success: function (response) {
                        if(response.error){
                            alert(response.error);
                            return;
                        }else{
                            console.log(response);
                            console.log('{% static 'o' %}'.replace('o', response));
                            window.open('{% static 'o' %}'.replace('o', response), '_blank');
                        }
                    },
                    error: function (response) {
                        alert(error_server_message + "Error " + response.status);
                    }
                });


        });


    });
</script>


