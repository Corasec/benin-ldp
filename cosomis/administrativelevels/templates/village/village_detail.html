{% extends 'layouts/base.html' %}
{% load static i18n humanize bootstrap4 custom_tags %}

{% block extracss %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/detail.css' %}"/>
{% endblock %}


{% block content %}
    <div class="row mb-4">
        <div class="col-md-8 col-12">
            <div class="clearfix" id="attachments_images">

            </div>
            <div class="overlay" id="spin-attachments-images">
                <i class="fas fa-2x fa-sync-alt fa-spin"></i>
            </div>
        </div>
        <div class="col-md-4 col-12 mt-4 mt-md-0">
            <div class="card col-12">
                <div class="card-header pb-0">
                    <h5 class="font-weight-bold mb-0">{% translate "Population" %}</h5>
                </div>
                <div class="card-body p-2">
                    <table class="table">
                        <tbody>
                        <tr>
                            <td class="border-0 p-0 pl-2 text-left font-weight-bold">{% translate "Total" %}</td>
                            <td class="border-0 p-0 pr-2 text-right">{{ object.total_population }}</td>
                        </tr>
                        <tr>
                            <td class="border-0 p-0 pl-2 text-left font-weight-bold">{% translate "Men" %}</td>
                            <td class="border-0 p-0 pr-2 text-right">{{ object.population_men }}</td>
                        </tr>
                        <tr>
                            <td class="border-0 p-0 pl-2 text-left font-weight-bold">{% translate "Women" %}</td>
                            <td class="border-0 p-0 pr-2 text-right">{{ object.population_women }}</td>
                        </tr>
                        <tr>
                            <td class="border-0 p-0 pl-2 text-left font-weight-bold">{% translate "Young" %}</td>
                            <td class="border-0 p-0 pr-2 text-right">{{ object.population_young }}</td>
                        <tr>
                            <td class="border-0 p-0 pl-2 text-left font-weight-bold">{% translate "Elder" %}</td>
                            <td class="border-0 p-0 pr-2 text-right">{{ object.population_elder }}</td>
                        </tr>
                        <tr>
                            <td class="border-0 p-0 pl-2 text-left font-weight-bold">{% translate "Handicap" %}</td>
                            <td class="border-0 p-0 pr-2 text-right">{{ object.population_handicap }}</td>
                        </tr>
                        <tr>
                            <td class="border-0 p-0 pl-2 text-left font-weight-bold">{% translate "Agruculture" %}</td>
                            <td class="border-0 p-0 pr-2 text-right">{{ object.population_agriculturist }}</td>
                        </tr>
                        <tr>
                            <td class="border-0 p-0 pl-2 text-left font-weight-bold">{% translate "Breeders" %}</td>
                            <td class="border-0 p-0 pr-2 text-right">{{ object.population_pastoralist }}</td>
                        </tr>
                        <tr>
                            <td class="border-0 p-0 pl-2 text-left font-weight-bold">{% translate "Minorities" %}</td>
                            <td class="border-0 p-0 pr-2 text-right">{{ object.population_minorities }}</td>
                        </tr>
                        <tr>
                            <td class="border-0 p-0 pl-2 text-left font-weight-bold">{% translate "Languages" %}</td>
                            <td class="border-0 p-0 pr-2 text-right">{{ object.main_languages }}</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card col-12">
                <div class="card-header pb-0">
                    <h5 class="font-weight-bold mb-0">{% translate 'Planning Cycle' %}</h5>
                </div>
                <div class="card-body p-2">
                    <table class="table">
                        <tbody>
                        <tr>
                            <td class="border-0 p-0 pl-2 text-left font-weight-bold">{% translate 'Phase' %}</td>
                            <td class="border-0 p-0 pr-2 text-right">{{ planning_status.current_phase.name }}</td>
                        </tr>
                        <tr>
                            <td class="border-0 p-0 pl-2 text-left font-weight-bold">{% translate 'Activity' %}</td>
                            <td class="border-0 p-0 pr-2 text-right">{{ planning_status.current_activity.name }}</td>
                        </tr>
                        <tr>
                            <td class="border-0 p-0 pl-2 text-left font-weight-bold">{% translate 'Task' %}</td>
                            <td class="border-0 p-0 pr-2 text-right">{{ planning_status.current_task.name }}</td>
                        </tr>
                        <tr>
                            <td class="border-0 p-0 pl-2 text-left font-weight-bold">{% translate "Completed" %}</td>
                            <td class="border-0 p-0 pr-2 text-right">{{ planning_status.completed|intcomma }} %</td>
                        <tr>
                            <td class="border-0 p-0 pl-2 text-left font-weight-bold">{% translate "Priorities Identified" %}</td>
                            <td class="border-0 p-0 pr-2 text-right">{{ planning_status.priorities_identified }}</td>
                        </tr>
                        <tr>
                            <td class="border-0 p-0 pl-2 text-left font-weight-bold">{% translate "Village Development Plan Date" %}</td>
                            <td class="border-0 p-0 pr-2 text-right">{{ planning_status.village_development_plan_date }}</td>
                        </tr>
                        <tr>
                            <td class="border-0 p-0 pl-2 text-left font-weight-bold">{% translate "Facilitator" %}</td>
                            <td class="border-0 p-0 pr-2 text-right">{{ planning_status.facilitator }}</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body table-responsive">
                    <div class="col-12">
                        <ul class="nav nav-tabs">
                            <li class="nav-item btn p-0"><a class="nav-link active" data-toggle="tab"
                                                            href="#priorities">{% translate "Priorities" %}</a></li>
                            <li class="nav-item btn p-0 pl-2 pr-2"><a class="nav-link" data-toggle="tab"
                                                                      href="#village_population">{% translate "Village population" %}</a>
                            </li>
                            <li class="nav-item btn p-0 pl-2 pr-2"><a class="nav-link" data-toggle="tab"
                                                                      href="#infrastructure_services">{% translate "Infrastructure and Services" %}</a>
                            </li>
                            <li class="nav-item btn p-0 pl-2 pr-2"><a class="nav-link" data-toggle="tab"
                                                                      href="#planning_cycle">{% translate "Planning Cycle" %}</a>
                            </li>
                            <li class="nav-item btn p-0 pl-2 pr-2"><a class="nav-link" data-toggle="tab"
                                                                      href="#financial_informations">{% translate "Financial informations" %}</a>
                            </li>
                            <li class="nav-item btn p-0 pl-2 pr-2"><a class="nav-link" data-toggle="tab"
                                                                      href="#grm">{% translate "GRM" %}</a></li>
                            <li class="nav-item btn p-0"><a class="nav-link" data-toggle="tab"
                                                            href="#diagnostics">{% translate "Diagnostics" %}</a></li>
                            <li class="nav-item btn p-0"><a class="nav-link" data-toggle="tab"
                                                            href="#climate">{% translate "Climate" %}</a></li>
                        </ul>

                        <div class="tab-content">
                            <div id="priorities" class="tab-pane active">
                                <div class="card">
                                    <div class="card-body">
                                        {% include 'shared/priorities_table.html' %}
                                    </div>
                                </div>
                            </div>
                            <div id="village_population" class="tab-pane fade">
                                <h3>{% translate "In construction" %}</h3>
                                {% comment %}<div class="row">
                                <div class="col-12"></div>
                            </div>
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5>{% translate "Population and community details" %}</h5>
                                                    <div id="population_and_community_details"></div>
                                                </div>

                                                <div class="overlay" id="spin-population-community-details">
                                                    <i class="fas fa-2x fa-sync-alt fa-spin"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5>{% translate "Civil servants and associations in the village" %}</h5>
                                                    <div id="civil_servants_associations"></div>
                                                </div>

                                                <div class="overlay" id="spin-civil-servants-associations">
                                                    <i class="fas fa-2x fa-sync-alt fa-spin"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>{% endcomment %}
                            </div>
                            <div id="infrastructure_services" class="tab-pane fade">
                                <h3>{% translate "In construction" %}</h3>
                                {% comment %} <div class="row">
                                <div class="col-12"></div>
                            </div>
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5>{% translate "Infrastructure and Services" %}</h5>
                                                    <div id="infrastructure_and_services"></div>
                                                </div>

                                                <div class="overlay" id="spin-infrastructure-services">
                                                    <i class="fas fa-2x fa-sync-alt fa-spin"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>{% endcomment %}
                            </div>
                            <div id="planning_cycle" class="tab-pane fade">
                                <div class="card">
                                    <div class="card-body">
                                        {% include 'village/tabs/planning_cycle.html' %}
                                    </div>
                                </div>
                            </div>
                            <div id="financial_informations" class="tab-pane fade">
                                <h3>{% translate "In construction" %}</h3>
                            </div>
                            <div id="grm" class="tab-pane fade">
                                <h3>{% translate "In construction" %}</h3>
                            </div>
                            <div id="diagnostics" class="tab-pane fade">
                                <h3>{% translate "In construction" %}</h3>
                            </div>
                            <div id="climate" class="tab-pane fade">
                                <div class="overlay-wrapper" style="width: 500px">
                                    <div id="mapid"></div>
                                    <div class="overlay z-index1000 map-spin irs--round">
                                        <i class="fas fa-3x fa-sync-alt fa-spin">
                                        </i>
                                    </div>
                                    <div class="second-overlay z-index1000 map-spin" id="load-percentage"></div>
                                    <div class="second-overlay z-index1000 fs38" id="map-message"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>



{% endblock %}

{% block modals %}
    {{ block.super }}

    <div class="modal fade" id="taskModalLong" tabindex="-1" role="dialog" aria-labelledby="taskModalLongTitle"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div id="modal-content" class="modal-content">
                {#            <div class="modal-header">#}
                {#                <h4 class="modal-title text-primary" id="taskModalTitle">...</h4>#}
                {##}
                {#                <span class="badge badge-pill badge-lg badge-info ml-1" id="taskModalStatus">...</span>#}
                {##}
                {#                <button type="button" class="close" data-dismiss="modal" aria-label="Close">#}
                {#                    <span aria-hidden="true">&times;</span>#}
                {#                </button>#}
                {#            </div>#}
                {#            <div class="modal-body">#}
                {#                <p id="taskModalDescription">#}
                {#                    ...#}
                {#                </p>#}
                {#                <br>#}
                {#                <div id="taskModalAttrs"></div>#}
                {#            </div>#}
            </div>
        </div>
    </div>

{% endblock %}



{% block javascript %}
    {{ block.super }}

    <!-- Attachments script for carrousel -->
    <script type="text/javascript">

        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        });
        let spin_attachments_images = $("#spin-attachments-images");
        let attachments_images = $("#attachments_images");
        spin_attachments_images.show();
        attachments_images.html(`
    {% if images_data.exists_at_least_image %}

        <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
            <ol class="carousel-indicators">
                {% for image in images_data.images %}
                    <li data-target="#carouselExampleIndicators" data-slide-to="{{ forloop.counter }}"
            {% if image.url == images_data.first_image.url %}class="active"{% endif %} ></li>
                {% endfor %}
            </ol>
            <div class="carousel-inner">
                {% for image in images_data.images %}
                    <div class="carousel-item {% if image.url == images_data.first_image.url %}active{% endif %}">
                        <a href="{% url 'administrativelevels:attachments' %}?administrative_level={{ object.id }}">
                            <img class="d-block w-100" src="{{ image.url|imgAWSS3Filter }}"
                            style="height: 500px !important;"
                            alt="{{ image.task }}">
                        </a>
                    </div>
                {% endfor %}
            </div>
            <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="sr-only">Previous</span>
            </a>
            <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="sr-only">Next</span>
            </a>
        </div>

    {% else %}
    <a href="{% url 'administrativelevels:attachments' %}?administrative_level={{ object.id }}">
                <img class="card-img rounded" src="{% static 'images/village-image.jpg' %}"
    alt="Card image">
    </a>

    {% endif %}
    `);
        spin_attachments_images.hide();
    </script>

    <script src="{% static 'plugins/datepicker/datepicker.js' %}"></script>
    <script src="{% static 'plugins/datepicker/datepicker.en.js' %}"></script>
    <script src="{% static 'plugins/datepicker/datepicker.custom.js' %}"></script>

    <!-- Planning cycle script -->
    <script type="text/javascript">
        $(document).ready(function () {
            $(".pc-btn").on('click', function () {

                let phase_id = $(this).attr("id").split("-")[3];
                let activity_buttons = $("#v-phase-" + phase_id + "-pills-tab").children();
                let has_selected = false;
                $(".tasks-pane").removeClass("active show");
                activity_buttons.each(function () {
                    if ($(this).hasClass("active")) {
                        let activity_id = $(this).attr("id").split("-")[3];
                        $("#activity-" + activity_id + "-content").tab("show");
                        has_selected = true;
                    }
                });
                if (!has_selected) {
                    let single_button = $("#v-phase-" + phase_id + "-pills-tab").children(":first-child");
                    let activity_id = single_button.attr("id").split("-")[3];
                    single_button.addClass("active")
                    $("#activity-" + activity_id + "-content").tab("show");
                }
            });

            $('#taskModalLong').on('shown.bs.modal', function (e) {
                let pk = e.relatedTarget.id.split('-')[3];
                let base_url = "{% url 'administrativelevels:utils:task_detail' 0 %}";
                base_url = base_url.replace(0, pk);
                $.ajax({
                    type: "GET",
                    url: base_url,
                    success: function (response) {
                        console.log(response);
                        $('#modal-content').html(response);
                        {#let attr_container = $('#taskModalAttrs');#}
                        {#$('#taskModalTitle').html(response.name);#}
                        {#$('#taskModalDescription').html(response.description);#}
                        {#$('#taskModalStatus').html(response.status);#}
                        {#attr_container.html('');#}
                        {#console.log(response);#}
                        {#response.meta.forEach((element) => {#}
                        {#    if(element.type == 'text_area') {#}
                        {#        attr_container.html(attr_container.html() + `<div class="form-group">#}
                        {#            <label>${element.label}</label>#}
                        {#            <textarea class="form-control" rows="6">${element.response}</textarea>#}
                        {#          </div>#}
                        {#          <br>#}
                        {#        `);#}
                        {#    } else if(element.type == 'link') {#}
                        {#        attr_container.html(attr_container.html() + `<div class="form-group">#}
                        {#            <label>${element.label}</label>#}
                        {#            <a href="${element.response}" target="_blank">Link</a>#}
                        {#          </div>#}
                        {#          <br>#}
                        {#        `);#}
                        {#    } else {#}
                        {#        attr_container.html(attr_container.html() + `<div class="form-group">#}
                        {#            <label>${element.label}</label>#}
                        {#            <input type="text" class="form-control" value="${element.response}">#}
                        {#          </div>#}
                        {#          <br>#}
                        {#        `);#}
                        {#    }#}
                        {#})
                            ;
                            #}
                        }
                    });
            })
            });
    </script>
    <script src="{% static 'plugins/mapbox-gl-js/v2.4.1/mapbox-gl.js' %}"></script>
    <script>

        mapboxgl.accessToken = 'pk.eyJ1Ijoiam9yZ2VkYXZpZGdiIiwiYSI6ImNrczUzbWluYzBkNGEybnMzd2ZsMmJwZGgifQ.F6JC13lUQIXkX2XEOqqGfw';

        fetch("{% static 'grid_clusterID.geojson' %}")
            .then(response => response.json())
            .then(data => {

                let map_spin = $('.map-spin');
                let regions_spin = $('#regions-nav-link .overlay');
                let regions_angle = $('#regions-nav-link .fa-angle-left');
                let sidebar_back = $('#sidebar_back');
                let load_percentage = $('#load-percentage');
                let map_message = $('#map-message');
                let around_africa_id = 'around_africa';

                function calculateBoundingBox(geojson) {
                    var minX = geojson.features[0].geometry.coordinates[0][0][0];
                    var minY = geojson.features[0].geometry.coordinates[0][0][1];
                    var maxX = geojson.features[0].geometry.coordinates[0][1][0];
                    var maxY = geojson.features[0].geometry.coordinates[0][1][1];
                    geojson.features.forEach(function (feature) {
                        feature.geometry.coordinates[0].forEach(function (coordinate) {
                            if (!minX || coordinate[0] < minX) minX = coordinate[0];
                            if (!minY || coordinate[1] < minY) minY = coordinate[1];
                            if (!maxX || coordinate[0] > maxX) maxX = coordinate[0];
                            if (!maxY || coordinate[1] > maxY) maxY = coordinate[1];
                        });
                    });

                    return [[minX, minY], [maxX, maxY]];
                }

                function clearAllTimeout() {
                    let id = window.setTimeout(function () {
                    }, 0);

                    while (id--) {
                        window.clearTimeout(id); // will do nothing if no timeout with id is present
                    }
                }

                function enableElements() {
                    clearAllTimeout();
                    if (map_message.html()) {
                        setTimeout(function () {
                            map_message.html('').hide();
                            map_spin.hide();
                        }, 2000);
                    } else {
                        map_spin.hide();
                        map_message.hide();
                    }
                    sidebar_back.removeClass('disabled');
                    load_percentage.html('');
                }

                var filteredFeatures = data.features.filter(function (feature) {
                    return feature.properties.Country === 'Togo';  // TODO: Filter with coordinates
                });

                var geoJson = {
                    "type": "FeatureCollection",
                    "features": filteredFeatures
                };
                var bbox = calculateBoundingBox(geoJson);
                const mymap = new mapboxgl.Map({
                    container: 'mapid', // container ID
                    //style: 'mapbox://styles/mapbox/streets-v11', // style URL
                    style: 'mapbox://styles/jorgedavidgb/cktwydyi118en18l9alhtk5ds', // style URL
                });

                mymap.fitBounds(bbox);


                mymap.on('load', () => {
                    mymap.dragRotate.disable();

                    mymap.addSource(around_africa_id, {
                        'type': 'geojson',
                        'data': geoJson
                    });

                    mymap.addLayer({
                        'id': around_africa_id,
                        'type': 'fill',
                        'source': around_africa_id,
                        'layout': {},
                        'paint': {
                            'fill-color': '#ed78b3',
                            'fill-opacity': 0.5
                        }
                    });
                });

                regions_angle.hide();
                regions_spin.show();

                mymap.on('load', (e) => {
                    setTimeout(function () {
                        map_spin.hide();
                        map_message.hide();
                    }, 1000);
                });

                mymap.on('idle', (e) => {
                    setTimeout(function () {
                        enableElements();
                    }, 1000);
                });

            });

    </script>
{% endblock %}